/*!
 * doscuss - A Dojo/Node.js Forum and Mailing List
 * Forum Module
 *
 */

var util = require('util'),
	colors = require('colors'),
	sqlite3 = require('sqlite3'),
	dUtils = require('../doscussUtil'),
	Post = require('./Post'),
	Posts = require('./Posts');

var forum = module.exports = exports;

/* Forum Object */
forum.init = function(forumDb) {
	forum.db = new sqlite3.Database(forumDb);
};

forum.statements = {selects: {}, selectall: {}, inserts: {}, updates: {}, deletes: {}};

forum.getPosts = function(range, filter, callback){
	var posts = new Posts(this.db, filter);
	posts.load(range, function(){
		if(callback){
			callback(posts.data());
		}
	});
};

forum.getPost = function(id, callback) {
	var post = new Post({id:id}),
		stmt = this.statements.selects[post._table] || (this.statements.selects[post._table] = this.db.prepare(post.toSqlSelect()));
	stmt.all(post.toSqlId(), function(err, rows){
		if (err) throw err;
		if (rows.length){
			post.fromSql(rows[0]);
		}else{
			post.id = null;
		}
		if (callback){
			callback(post);
		}
	});
};

forum.putPost = function(post, callback) {
};

forum.postPost = function(post, callback) {
};

forum.deletePost = function(id, callback) {
};

forum.close = function() {
	forum.db.close();
	forum.db = null;
};